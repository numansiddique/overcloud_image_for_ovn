From 870d7bf4bbd29d6415115484f900969cae26b37c Mon Sep 17 00:00:00 2001
From: Dan Radez <dradez@redhat.com>
Date: Fri, 10 Mar 2017 10:57:30 -0500
Subject: [PATCH 2/2] Adding OVNDBs vip to keepalive

Change-Id: I56f7e3280eda6fe3cc8dd677ad06b700ef504829
---
 manifests/keepalived.pp | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/manifests/keepalived.pp b/manifests/keepalived.pp
index a6d5832..aa0e5d6 100644
--- a/manifests/keepalived.pp
+++ b/manifests/keepalived.pp
@@ -59,6 +59,12 @@
 #  A string.
 #  Defaults to false
 #
+# [*ovndbs_virtual_ip*]
+#  Virtual IP on the OVNDBs service.
+#  A string.
+#  Defaults to false
+#
+
 class tripleo::keepalived (
   $controller_virtual_ip,
   $control_virtual_interface,
@@ -68,6 +74,7 @@ class tripleo::keepalived (
   $storage_virtual_ip      = false,
   $storage_mgmt_virtual_ip = false,
   $redis_virtual_ip        = false,
+  $ovndbs_virtual_ip       = false,
 ) {
 
   case $::osfamily {
@@ -178,4 +185,15 @@ class tripleo::keepalived (
       priority     => 101,
     }
   }
+  if $ovndbs_virtual_ip and $ovndbs_virtual_ip != $controller_virtual_ip {
+    $ovndbs_virtual_interface = interface_for_ip($ovndbs_virtual_ip)
+    # KEEPALIVE OVNDBS MANAGEMENT NETWORK
+    keepalived::instance { '57':
+      interface    => $ovndbs_virtual_interface,
+      virtual_ips  => [join([$ovndbs_virtual_ip, ' dev ', $ovndbs_virtual_interface])],
+      state        => 'MASTER',
+      track_script => ['haproxy'],
+      priority     => 101,
+    }
+  }
 }
-- 
2.9.3

